# This script is sourced from the top-level Android emulator
# configuration script, and relies on the following macro
# definitions:
#
#  QEMU2_TOP_DIR: top-level QEMU2 source directory.
#  OUT_DIR: top-level build output directory.

QEMU2_AUTOGENERATED_DIR=$OUT_DIR/build/qemu2-qapi-auto-generated

replace_with_if_different () {
    cmp -s "$1" "$2" || mv "$2" "$1"
}

probe_prebuilts_dir "QEMU2 Dependencies" \
    QEMU2_DEPS_PREBUILTS_DIR \
    qemu-android-deps

echo "QEMU2_DEPS_PREBUILTS_DIR := $QEMU2_DEPS_PREBUILTS_DIR" >> $config_mk

python $QEMU2_TOP_DIR/scripts/qapi-types.py \
    --builtins \
    -o $QEMU2_AUTOGENERATED_DIR \
    $QEMU2_TOP_DIR/qapi-schema.json

python $QEMU2_TOP_DIR/scripts/qapi-visit.py \
    --builtins \
    -o $QEMU2_AUTOGENERATED_DIR \
    $QEMU2_TOP_DIR/qapi-schema.json

python $QEMU2_TOP_DIR/scripts/qapi-event.py \
    -o $QEMU2_AUTOGENERATED_DIR \
    $QEMU2_TOP_DIR/qapi-schema.json

python $QEMU2_TOP_DIR/scripts/qapi-introspect.py \
    -o $QEMU2_AUTOGENERATED_DIR \
    $QEMU2_TOP_DIR/qapi-schema.json

python $QEMU2_TOP_DIR/scripts/qapi-commands.py \
    -o $QEMU2_AUTOGENERATED_DIR \
    $QEMU2_TOP_DIR/qapi-schema.json

python $QEMU2_TOP_DIR/scripts/modules/module_block.py \
     $QEMU2_TOP_DIR/module_block.h


generate_trace() {
  local OUT=$1
  local GROUP=$2
  local FORMAT=$3
  local TRACEFILE=$4
  log "GEN $OUT"
  mkdir -p $(dirname $QEMU2_AUTOGENERATED_DIR/$OUT)
  python $QEMU2_TOP_DIR/scripts/tracetool.py \
    --group=$GROUP --format=$FORMAT --backends=nop $TRACEFILE > $QEMU2_AUTOGENERATED_DIR/$OUT
}

append_trace() {
  local OUT=trace.h
  local GROUP=$2
  local FORMAT=$3
  local TRACEFILE=$4
  log "GEN $OUT"
  mkdir -p $(dirname $QEMU2_AUTOGENERATED_DIR/$OUT)
  python $QEMU2_TOP_DIR/scripts/tracetool.py \
    --group=$GROUP --format=$FORMAT --backends=nop $TRACEFILE >> $QEMU2_AUTOGENERATED_DIR/$OUT
}

generate_trace trace/generated-tcg-tracers.h root tcg-h trace-events
generate_trace trace/generated-helpers-wrappers.h root tcg-helper-wrapper-h trace-events
generate_trace trace/generated-helpers.h root tcg-helper-h trace-events
generate_trace trace/generated-helpers.c root tcg-helper-c trace-events

generate_trace trace-root.h root h trace-events

generate_trace util/trace.h util h util/trace-events
generate_trace crypto/trace.h crypto h crypto/trace-events
generate_trace io/trace.h io h io/trace-events
generate_trace migration/trace.h migration h migration/trace-events
generate_trace block/trace.h block h block/trace-events
generate_trace backends/trace.h backends h backends/trace-events
generate_trace hw/block/trace.h hw_block h hw/block/trace-events
generate_trace hw/block/dataplane/trace.h hw_block_dataplane h hw/block/dataplane/trace-events
generate_trace hw/char/trace.h hw_char h hw/char/trace-events
generate_trace hw/intc/trace.h hw_intc h hw/intc/trace-events
generate_trace hw/net/trace.h hw_net h hw/net/trace-events
generate_trace hw/virtio/trace.h hw_virtio h hw/virtio/trace-events
generate_trace hw/audio/trace.h hw_audio h hw/audio/trace-events
generate_trace hw/misc/trace.h hw_misc h hw/misc/trace-events
generate_trace hw/usb/trace.h hw_usb h hw/usb/trace-events
generate_trace hw/scsi/trace.h hw_scsi h hw/scsi/trace-events
generate_trace hw/nvram/trace.h hw_nvram h hw/nvram/trace-events
generate_trace hw/display/trace.h hw_display h hw/display/trace-events
generate_trace hw/input/trace.h hw_input h hw/input/trace-events
generate_trace hw/timer/trace.h hw_timer h hw/timer/trace-events
generate_trace hw/dma/trace.h hw_dma h hw/dma/trace-events
generate_trace hw/sparc/trace.h hw_sparc h hw/sparc/trace-events
generate_trace hw/sd/trace.h hw_sd h hw/sd/trace-events
generate_trace hw/isa/trace.h hw_isa h hw/isa/trace-events
generate_trace hw/mem/trace.h hw_mem h hw/mem/trace-events
generate_trace hw/i386/trace.h hw_i386 h hw/i386/trace-events
generate_trace hw/i386/xen/trace.h hw_i386_xen h hw/i386/xen/trace-events
generate_trace hw/9pfs/trace.h hw_9pfs h hw/9pfs/trace-events
generate_trace hw/ppc/trace.h hw_ppc h hw/ppc/trace-events
generate_trace hw/pci/trace.h hw_pci h hw/pci/trace-events
generate_trace hw/s390x/trace.h hw_s390x h hw/s390x/trace-events
generate_trace hw/vfio/trace.h hw_vfio h hw/vfio/trace-events
generate_trace hw/acpi/trace.h hw_acpi h hw/acpi/trace-events
generate_trace hw/arm/trace.h hw_arm h hw/arm/trace-events
generate_trace hw/alpha/trace.h hw_alpha h hw/alpha/trace-events
generate_trace hw/xen/trace.h hw_xen h hw/xen/trace-events
generate_trace ui/trace.h ui h ui/trace-events
generate_trace audio/trace.h audio h audio/trace-events
generate_trace net/trace.h net h net/trace-events
generate_trace target/arm/trace.h target_arm h target/arm/trace-events
generate_trace target/i386/trace.h target_i386 h target/i386/trace-events
generate_trace target/mips/trace.h target_mips h target/mips/trace-events
generate_trace target/sparc/trace.h target_sparc h target/sparc/trace-events
generate_trace target/s390x/trace.h target_s390x h target/s390x/trace-events
generate_trace target/ppc/trace.h target_ppc h target/ppc/trace-events
generate_trace qom/trace.h qom h qom/trace-events
generate_trace linux-user/trace.h linux_user h linux-user/trace-events
generate_trace qapi/trace.h qapi h qapi/trace-events

generate_trace trace-root.c root c trace-events
generate_trace util/trace.c util c util/trace-events
generate_trace crypto/trace.c crypto c crypto/trace-events
generate_trace io/trace.c io c io/trace-events
generate_trace migration/trace.c migration c migration/trace-events
generate_trace block/trace.c block c block/trace-events
generate_trace backends/trace.c backends c backends/trace-events
generate_trace hw/block/trace.c hw_block c hw/block/trace-events
generate_trace hw/block/dataplane/trace.c hw_block_dataplane c hw/block/dataplane/trace-events
generate_trace hw/char/trace.c hw_char c hw/char/trace-events
generate_trace hw/intc/trace.c hw_intc c hw/intc/trace-events
generate_trace hw/net/trace.c hw_net c hw/net/trace-events
generate_trace hw/virtio/trace.c hw_virtio c hw/virtio/trace-events
generate_trace hw/audio/trace.c hw_audio c hw/audio/trace-events
generate_trace hw/misc/trace.c hw_misc c hw/misc/trace-events
generate_trace hw/usb/trace.c hw_usb c hw/usb/trace-events
generate_trace hw/scsi/trace.c hw_scsi c hw/scsi/trace-events
generate_trace hw/nvram/trace.c hw_nvram c hw/nvram/trace-events
generate_trace hw/display/trace.c hw_display c hw/display/trace-events
generate_trace hw/input/trace.c hw_input c hw/input/trace-events
generate_trace hw/timer/trace.c hw_timer c hw/timer/trace-events
generate_trace hw/dma/trace.c hw_dma c hw/dma/trace-events
generate_trace hw/sparc/trace.c hw_sparc c hw/sparc/trace-events
generate_trace hw/sd/trace.c hw_sd c hw/sd/trace-events
generate_trace hw/isa/trace.c hw_isa c hw/isa/trace-events
generate_trace hw/mem/trace.c hw_mem c hw/mem/trace-events
generate_trace hw/i386/trace.c hw_i386 c hw/i386/trace-events
generate_trace hw/i386/xen/trace.c hw_i386_xen c hw/i386/xen/trace-events
generate_trace hw/9pfs/trace.c hw_9pfs c hw/9pfs/trace-events
generate_trace hw/ppc/trace.c hw_ppc c hw/ppc/trace-events
generate_trace hw/pci/trace.c hw_pci c hw/pci/trace-events
generate_trace hw/s390x/trace.c hw_s390x c hw/s390x/trace-events
generate_trace hw/vfio/trace.c hw_vfio c hw/vfio/trace-events
generate_trace hw/acpi/trace.c hw_acpi c hw/acpi/trace-events
generate_trace hw/arm/trace.c hw_arm c hw/arm/trace-events
generate_trace hw/alpha/trace.c hw_alpha c hw/alpha/trace-events
generate_trace hw/xen/trace.c hw_xen c hw/xen/trace-events
generate_trace ui/trace.c ui c ui/trace-events
generate_trace audio/trace.c audio c audio/trace-events
generate_trace net/trace.c net c net/trace-events
generate_trace target/arm/trace.c target_arm c target/arm/trace-events
generate_trace target/i386/trace.c target_i386 c target/i386/trace-events
generate_trace target/mips/trace.c target_mips c target/mips/trace-events
generate_trace target/sparc/trace.c target_sparc c target/sparc/trace-events
generate_trace target/s390x/trace.c target_s390x c target/s390x/trace-events
generate_trace target/ppc/trace.c target_ppc c target/ppc/trace-events
generate_trace qom/trace.c qom c qom/trace-events
generate_trace linux-user/trace.c linux_user c linux-user/trace-events
generate_trace qapi/trace.c qapi c qapi/trace-events

bash $QEMU2_TOP_DIR/scripts/hxtool -h \
    < $QEMU2_TOP_DIR/qemu-options.hx \
    > $QEMU2_AUTOGENERATED_DIR/qemu-options.def

replace_with_if_different \
    "$QEMU2_TOP_DIR/qemu-options.def" \
    $QEMU2_AUTOGENERATED_DIR/qemu-options.def


bash $QEMU2_TOP_DIR/scripts/hxtool -h \
    < $QEMU2_TOP_DIR/hmp-commands.hx \
    > $QEMU2_AUTOGENERATED_DIR/hmp-commands.h

bash $QEMU2_TOP_DIR/scripts/hxtool -h \
    < $QEMU2_TOP_DIR/hmp-commands-info.hx \
    > $QEMU2_AUTOGENERATED_DIR/hmp-commands-info.h

bash $QEMU2_TOP_DIR/scripts/hxtool -h \
    < $QEMU2_TOP_DIR/qemu-img-cmds.hx \
    > $QEMU2_AUTOGENERATED_DIR/qemu-img-cmds.h

rm -f $QEMU2_AUTOGENERATED_DIR/gdbstub-xml-arm64.c
bash $QEMU2_TOP_DIR/scripts/feature_to_c.sh \
    $QEMU2_AUTOGENERATED_DIR/gdbstub-xml-arm64.c \
    $QEMU2_TOP_DIR/gdb-xml/aarch64-core.xml \
    $QEMU2_TOP_DIR/gdb-xml/aarch64-fpu.xml \
    $QEMU2_TOP_DIR/gdb-xml/arm-core.xml \
    $QEMU2_TOP_DIR/gdb-xml/arm-vfp.xml \
    $QEMU2_TOP_DIR/gdb-xml/arm-vfp3.xml \
    $QEMU2_TOP_DIR/gdb-xml/arm-neon.xml

rm -f $QEMU2_AUTOGENERATED_DIR/gdbstub-xml-arm.c
bash $QEMU2_TOP_DIR/scripts/feature_to_c.sh \
    $QEMU2_AUTOGENERATED_DIR/gdbstub-xml-arm.c \
    $QEMU2_TOP_DIR/gdb-xml/arm-core.xml \
    $QEMU2_TOP_DIR/gdb-xml/arm-vfp.xml \
    $QEMU2_TOP_DIR/gdb-xml/arm-vfp3.xml \
    $QEMU2_TOP_DIR/gdb-xml/arm-neon.xml

if [ "$OPT_MINGW" ]; then
    $OUT_DIR/objs/build/toolchain/x86_64-mingw32-windres \
        -o $QEMU2_AUTOGENERATED_DIR/version.o \
        $QEMU2_TOP_DIR/version.rc
fi

# Generate qemu-version.h from Git history.
QEMU_VERSION_H=$QEMU2_AUTOGENERATED_DIR/qemu-version.h
QEMU_VERSION_H_TMP=$QEMU_VERSION_H.tmp
rm -f "$QEMU_VERSION_H"
if [ -d "$QEMU2_TOP_DIR/.git" ]; then
    QEMU_VERSION=$(cd "$QEMU2_TOP_DIR" && git describe --match 'v*' 2>/dev/null | tr -d '\n')
else
    QEMU_VERSION=$(date "+%Y-%m-%d")
fi

echo "QEMU2    : Version [$QEMU_VERSION]"

printf "#define QEMU_PKGVERSION \"(android-%s)\"\n" "$QEMU_VERSION" > $QEMU_VERSION_H_TMP
replace_with_if_different "$QEMU_VERSION_H" "$QEMU_VERSION_H_TMP"
rm -f "$QEMU_VERSION_TMP_H"

# Work-around for a QEMU2 bug:
# $QEMU2/linux-headers/linux/kvm.h includes <asm/kvm.h>
# but $QEMU2/linux-headers/asm/ doesn't exist. It is supposed
# to be a symlink to $QEMU2/linux-headers/asm-x86/
#
# The end result is that the <asm/kvm.h> from the host system
# or toolchain sysroot is being included, which ends up in a
# conflict. Work around it by creating a symlink here
rm -f $QEMU2_AUTOGENERATED_DIR/asm
ln -sf $QEMU2_TOP_DIR/linux-headers/asm-x86 $QEMU2_AUTOGENERATED_DIR/asm
